<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line Hunter - Zoom Meeting Service</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .countdown {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .zoom-button {
            background: linear-gradient(135deg, #2D8CFF 0%, #1E5799 100%);
            transition: all 0.3s ease;
        }
        .zoom-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(45, 140, 255, 0.3);
        }
        .subscription-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .admin-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <!-- Login/Signup Section -->
    <div id="authSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-4 w-full max-w-xs fade-in">
            <div class="text-center mb-4">
                <img src="logo.png" alt="Line Hunter" class="w-36 h-36 mx-auto mb-4">
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">User ID</label>
                    <input type="text" id="loginUserId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your user ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your password">
                </div>
                <button onclick="login()" class="w-3/4 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300 font-semibold mx-auto block mt-8">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </div>

            <!-- Admin Contact Info -->
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    New Account? Contact Admin for Registration
                </p>
            </div>
        </div>
    </div>

    <!-- User Panel -->
    <div id="userPanel" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Line Hunter ðŸ’€</h2>
                        <p class="text-gray-600">Welcome back, <span id="userName" class="font-semibold"></span></p>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>

            <!-- Subscription Card -->
            <div class="subscription-card rounded-2xl shadow-lg p-8 mb-6 text-white fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">
                        <i class="fas fa-crown text-yellow-300 mr-2"></i>Subscription Status
                    </h3>
                    <span id="subscriptionStatusBadge" class="px-3 py-1 rounded-full text-sm font-semibold bg-white/20"></span>
                </div>
                
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="text-white/80">Plan:</span>
                        <span id="subscriptionPlan" class="font-semibold"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/80">Activated:</span>
                        <span id="subscriptionStartDate"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white/80">Expires:</span>
                        <span id="subscriptionExpiryDate"></span>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <p class="text-lg font-semibold mb-3">
                        <i class="far fa-clock mr-2"></i>Time Remaining
                    </p>
                    <div id="countdown" class="countdown text-2xl font-mono"></div>
                </div>
            </div>

            <!-- Join Line Button -->
            <div class="text-center fade-in">
                <button id="joinLineBtn" onclick="joinZoomMeeting()" class="zoom-button text-white px-8 py-4 rounded-xl text-lg font-semibold shadow-lg w-full max-w-xs">
                    <i class="fas fa-video mr-2"></i>Join Line
                </button>
                <p class="text-gray-700 mt-10 text-sm">
                    <i class="fas fa-headset mr-1"></i>
                    Need help or facing any issues?<br>
                    Please contact the admin for assistance.
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="admin-panel rounded-2xl shadow-lg p-6 mb-6 text-white fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">
                            <i class="fas fa-user-shield mr-2"></i>Admin Panel
                        </h2>
                        <p class="text-white/80">Manage Users and Subscriptions</p>
                    </div>
                    <button onclick="logout()" class="bg-white text-red-500 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>

            <!-- Users Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                    <div class="flex items-center">
                        <div class="bg-blue-100 rounded-full p-3 mr-4">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Total Users</p>
                            <p id="totalUsersCount" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                    <div class="flex items-center">
                        <div class="bg-green-100 rounded-full p-3 mr-4">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Active Users</p>
                            <p id="activeUsersCount" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                    <div class="flex items-center">
                        <div class="bg-red-100 rounded-full p-3 mr-4">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-600 text-sm">Expired Users</p>
                            <p id="expiredUsersCount" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create User Form - Hidden by default -->
            <div id="createUserForm" class="bg-white rounded-2xl shadow-lg p-6 mb-6 fade-in hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-user-plus mr-2"></i>Create New User
                    </h3>
                    <button onclick="closeCreateUserModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Name</label>
                        <input type="text" id="newUserName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="User name" oninput="updateUserId()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp Number</label>
                        <input type="tel" id="newUserWhatsApp" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="+1234567890">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User ID (Auto Generated)</label>
                        <input type="text" id="newUserEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-blue-50 focus:ring-2 focus:ring-purple-500" placeholder="Will be auto-generated" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password (Auto Generated)</label>
                        <input type="text" id="newUserPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-blue-50 focus:ring-2 focus:ring-purple-500" placeholder="Will be auto-generated" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zoom Link</label>
                        <input type="url" id="newUserZoomLink" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="https://zoom.us/j/...">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Plan</label>
                        <select id="newUserPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="monthly">Monthly</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="closeCreateUserModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="createUser()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition">
                        <i class="fas fa-plus mr-2"></i>Create User
                    </button>
                </div>
            </div>

            <!-- Users List -->
            <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-users mr-2"></i>All Users
                    </h3>
                    <button onclick="openCreateUserModal()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                        <i class="fas fa-plus mr-2"></i>Add New User
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Name</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">User ID</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Password</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Plan</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Expiry</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">WhatsApp</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage (in real app, this would be on a server)
        let users = JSON.parse(localStorage.getItem('lineHunterUsers')) || [
            {
                id: 1,
                userId: 'john001',
                name: 'John Doe',
                email: 'john@example.com',
                password: 'password123',
                role: 'user',
                zoomLink: 'https://zoom.us/j/123456789',
                locked: false,
                subscription: {
                    status: 'active',
                    plan: 'monthly',
                    startDate: '2024-01-01',
                    expiryDate: '2024-01-31'
                }
            },
            {
                id: 2,
                userId: 'SUSANTA',
                name: 'Admin',
                email: 'admin@linehunter.com',
                password: 'Susanta480@',
                role: 'admin',
                zoomLink: '',
                locked: false,
                subscription: {
                    status: 'active',
                    plan: 'monthly',
                    startDate: '2024-01-01',
                    expiryDate: '2024-12-31'
                }
            }
        ];
        
        // Save initial users to localStorage only if it's empty
        if (!localStorage.getItem('lineHunterUsers')) {
            localStorage.setItem('lineHunterUsers', JSON.stringify(users));
        } else {
            // Load existing users from localStorage
            users = JSON.parse(localStorage.getItem('lineHunterUsers'));
        }

        let currentUser = null;
        let countdownInterval = null;
        let expiryCheckInterval = null;
        let sessionTimeoutInterval = null;
        let sessionStartTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized. Users from localStorage:', users);
            
            // Force update admin credentials if they exist in localStorage
            const existingUsers = JSON.parse(localStorage.getItem('lineHunterUsers') || '[]');
            const adminUser = existingUsers.find(u => u.role === 'admin');
            
            if (adminUser) {
                // Update existing admin credentials
                adminUser.userId = 'SUSANTA';
                adminUser.password = 'Susanta480@';
                adminUser.name = 'Admin';
                localStorage.setItem('lineHunterUsers', JSON.stringify(existingUsers));
                users = existingUsers; // Update current users array
                console.log('Admin credentials updated in localStorage');
            }
            
            // Load remembered credentials if any
            const rememberedUserId = localStorage.getItem('rememberedUserId');
            const rememberedPassword = localStorage.getItem('rememberedPassword');
            
            if (rememberedUserId && rememberedPassword) {
                document.getElementById('loginUserId').value = rememberedUserId;
                document.getElementById('loginPassword').value = rememberedPassword;
            }
            
            // Add activity listeners to reset session timeout
            document.addEventListener('click', resetSessionTimeout);
            document.addEventListener('keypress', resetSessionTimeout);
            document.addEventListener('scroll', resetSessionTimeout);
            document.addEventListener('mousemove', resetSessionTimeout);
        });

        function saveUsers() {
            localStorage.setItem('lineHunterUsers', JSON.stringify(users));
        }

        function login() {
            const userId = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;

            console.log('Login attempt:', { userId, password });
            console.log('Available users:', users);
            console.log('Users array length:', users.length);

            if (!userId || !password) {
                showNotification('Please enter user ID and password', 'error');
                return;
            }

            const user = users.find(u => u.userId === userId && u.password === password);
            console.log('Found user:', user);
            console.log('User ID match:', users.map(u => ({ userId: u.userId, match: u.userId === userId })));
            console.log('Password match for user ID:', userId, users.find(u => u.userId === userId)?.password === password);
            
            if (user) {
                // Check if user is locked
                if (user.locked) {
                    showNotification('Your account has been locked. Please contact admin.', 'error');
                    return;
                }
                
                // Auto-save credentials to localStorage
                localStorage.setItem('rememberedUserId', userId);
                localStorage.setItem('rememberedPassword', password);
                
                currentUser = user;
                
                if (user.role === 'admin') {
                    showAdminPanel();
                } else {
                    showUserPanel();
                }
                
                showNotification(`Welcome back, ${user.name}!`, 'success');
            } else {
                showNotification('Invalid User ID or Password', 'error');
            }
        }

        function startSessionTimeout() {
            // Clear any existing session timeout
            if (sessionTimeoutInterval) {
                clearInterval(sessionTimeoutInterval);
            }
            
            // Set session start time
            sessionStartTime = Date.now();
            
            // Check session timeout every 10 seconds
            sessionTimeoutInterval = setInterval(() => {
                const elapsedMinutes = (Date.now() - sessionStartTime) / (1000 * 60);
                
                if (elapsedMinutes >= 5) {
                    showNotification('Your session has expired due to inactivity (5 minutes). Please login again.', 'info');
                    logout();
                }
            }, 10000); // Check every 10 seconds
        }

        function resetSessionTimeout() {
            // Reset session start time to current time
            sessionStartTime = Date.now();
        }

        function showUserPanel() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userPanel').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            // Check for expired users first
            checkAndUpdateExpiredUsers();
            
            // Refresh current user data immediately
            const updatedUser = users.find(u => u.id === currentUser.id);
            if (updatedUser) {
                // Check if user is already locked
                if (updatedUser.locked) {
                    showNotification('Your account is locked. Please contact admin.', 'error');
                    logout();
                    return;
                }
                currentUser = updatedUser;
            }
            
            // Start session timeout (5 minutes)
            startSessionTimeout();
            
            // Set up periodic check for expired users and lock status (every 3 seconds for faster response)
            if (expiryCheckInterval) {
                clearInterval(expiryCheckInterval);
            }
            expiryCheckInterval = setInterval(() => {
                checkAndUpdateExpiredUsers();
                
                // Check if current user is in pending logout queue
                if (window.pendingLogouts && window.pendingLogouts.includes(currentUser.id)) {
                    showNotification('Your account has been locked by admin. You have been logged out.', 'error');
                    // Remove from pending queue
                    window.pendingLogouts = window.pendingLogouts.filter(id => id !== currentUser.id);
                    logout();
                    return;
                }
                
                // Refresh current user data and update UI
                const updatedUser = users.find(u => u.id === currentUser.id);
                if (updatedUser) {
                    // Check if user was locked by admin
                    if (currentUser.locked !== updatedUser.locked && updatedUser.locked) {
                        // User was locked, force logout
                        showNotification('Your account has been locked by admin. You have been logged out.', 'error');
                        logout();
                        return;
                    }
                    currentUser = updatedUser;
                    updateUserPanelUI();
                    console.log('User panel updated - Status:', currentUser.subscription.status, 'Locked:', currentUser.locked);
                }
            }, 3000); // 3 seconds for faster response
            
            // Initial UI update
            updateUserPanelUI();
        }

        function updateUserPanelUI() {
            console.log('Updating user panel UI for:', currentUser.name, 'Status:', currentUser.subscription.status);
            
            // Update user name
            document.getElementById('userName').textContent = currentUser.name;
            
            // Update subscription info
            const sub = currentUser.subscription;
            
            // Update status badge
            const statusBadge = document.getElementById('subscriptionStatusBadge');
            statusBadge.textContent = sub.status.toUpperCase();
            
            // Set status badge color based on status
            if (sub.status === 'active') {
                statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-500 text-white';
            } else if (sub.status === 'expired') {
                statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-500 text-white';
            } else {
                statusBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gray-500 text-white';
            }
            
            document.getElementById('subscriptionPlan').textContent = sub.plan.charAt(0).toUpperCase() + sub.plan.slice(1);
            document.getElementById('subscriptionStartDate').textContent = new Date(sub.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            document.getElementById('subscriptionExpiryDate').textContent = formatExpiryDate(sub.expiryDate);
            
            // Update join button visibility
            const joinBtn = document.getElementById('joinLineBtn');
            if (sub.status === 'active' && new Date(sub.expiryDate) > new Date()) {
                joinBtn.style.display = 'inline-block';
                console.log('Join button visible - Active subscription');
            } else {
                joinBtn.style.display = 'none';
                console.log('Join button hidden - Expired subscription');
            }
            
            // Start countdown
            startCountdown(sub.expiryDate);
            
            // Show notification if status changed to expired
            if (sub.status === 'expired') {
                showNotification('Your subscription has expired. Please contact admin to renew.', 'error');
            }
        }

        function checkAndUpdateExpiredUsers() {
            const now = new Date();
            let updatedUsers = false;
            
            users.forEach(user => {
                if (user.role !== 'admin' && user.subscription.status === 'active') {
                    const expiryDate = new Date(user.subscription.expiryDate);
                    if (now > expiryDate) {
                        user.subscription.status = 'expired';
                        updatedUsers = true;
                        console.log(`User ${user.name} expired at ${new Date()}`);
                    }
                }
            });
            
            if (updatedUsers) {
                saveUsers();
                loadUsersTable();
                updateUserStatistics();
                showNotification('Some users have expired and been updated', 'info');
            }
        }

        function showAdminPanel() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            
            // Start session timeout (5 minutes)
            startSessionTimeout();
            
            // Check for expired users first
            checkAndUpdateExpiredUsers();
            
            loadUsersTable();
            updateUserStatistics();
        }

        function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            users.filter(u => u.role !== 'admin').forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${user.name}</td>
                    <td class="px-4 py-2">${user.userId}</td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <span id="password-${user.id}" class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">*****</span>
                            <button onclick="togglePassword(${user.id})" class="text-blue-500 hover:text-blue-700">
                                <i id="eye-icon-${user.id}" class="fas fa-eye"></i>
                            </button>
                            <button onclick="regeneratePassword(${user.id})" class="text-green-500 hover:text-green-700">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-2">${user.subscription.plan.charAt(0).toUpperCase() + user.subscription.plan.slice(1)}</td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(user.subscription.status)}">
                                ${user.subscription.status}
                            </span>
                            ${user.subscription.status === 'expired' ? `
                                <button onclick="renewUserPlan(${user.id})" class="text-green-500 hover:text-green-700" title="Renew Plan">
                                    <i class="fas fa-redo"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-4 py-2">${formatExpiryDate(user.subscription.expiryDate)}</td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <a href="https://wa.me/${user.whatsapp ? user.whatsapp.replace(/[^\d]/g, '') : ''}" target="_blank" class="text-green-500 hover:text-green-700">
                                ${user.whatsapp || 'N/A'}
                            </a>
                            <button onclick="editMobileNumber(${user.id})" class="text-blue-500 hover:text-blue-700" title="Edit Mobile Number">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-2">
                        <div class="flex items-center space-x-2">
                            <button onclick="sendWelcomeMessage(${user.id})" class="text-blue-500 hover:text-blue-700" title="Copy Welcome Message">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="toggleUserLock(${user.id})" class="${user.locked ? 'text-orange-500' : 'text-gray-500'} hover:text-orange-700" title="${user.locked ? 'Unlock User' : 'Lock User'}">
                                <i class="fas fa-${user.locked ? 'lock' : 'lock-open'}"></i>
                            </button>
                            <button onclick="deleteUser(${user.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function sendWelcomeMessage(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                const loginUrl = `${window.location.origin}${window.location.pathname}`;
                const message = `ðŸ’€ Welcome to Line Hunter! ðŸ’€

Dear ${user.name},

Your account has been created successfully! Here are your login details:

ðŸ”‘ User ID: ${user.userId}
ðŸ” Password: ${user.password}

ðŸ”— Login URL: ${loginUrl}

Please save your credentials safely. If you have any questions, feel free to contact us.

Best regards,
Line Hunter Team`;

                // Copy message to clipboard
                navigator.clipboard.writeText(message).then(() => {
                    showNotification(`Welcome message copied to clipboard! Send it to ${user.name} on WhatsApp.`, 'success');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = message;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification(`Welcome message copied! Send it to ${user.name} on WhatsApp.`, 'success');
                });
            }
        }

        function editMobileNumber(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                // Create edit mobile modal HTML
                const modalHtml = `
                    <div id="editMobileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-6 w-96">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-phone mr-2"></i>Edit Mobile Number for ${user.name}
                            </h3>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Mobile Number</label>
                                <input type="text" value="${user.whatsapp || 'N/A'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Mobile Number</label>
                                <input type="tel" id="newMobileNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter mobile number with country code" value="${user.whatsapp || ''}">
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeEditMobileModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    Cancel
                                </button>
                                <button onclick="updateMobileNumber(${userId})" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
                                    <i class="fas fa-check mr-2"></i>Update
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Focus on input field
                setTimeout(() => {
                    document.getElementById('newMobileNumber').focus();
                }, 100);
            }
        }

        function closeEditMobileModal() {
            const modal = document.getElementById('editMobileModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateMobileNumber(userId) {
            const user = users.find(u => u.id === userId);
            const newMobile = document.getElementById('newMobileNumber').value.trim();
            
            if (!user) {
                showNotification('User not found', 'error');
                return;
            }
            
            if (!newMobile) {
                showNotification('Please enter a mobile number', 'error');
                return;
            }
            
            // Basic mobile number validation (should contain only digits, +, -, spaces)
            const mobileRegex = /^[+]?[\d\s\-\(\)]+$/;
            if (!mobileRegex.test(newMobile)) {
                showNotification('Please enter a valid mobile number', 'error');
                return;
            }
            
            // Update user's mobile number
            user.whatsapp = newMobile;
            
            // Save changes
            saveUsers();
            
            // Update table
            loadUsersTable();
            
            // Close modal
            closeEditMobileModal();
            
            // Show success notification
            showNotification(`Mobile number updated successfully for ${user.name}: ${newMobile}`, 'success');
        }

        function toggleUserLock(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                const wasLocked = user.locked;
                user.locked = !user.locked;
                saveUsers();
                loadUsersTable();
                
                const action = user.locked ? 'locked' : 'unlocked';
                const message = user.locked ? 
                    `User ${user.name} ${action} successfully. They will be logged out if currently online.` :
                    `User ${user.name} ${action} successfully.`;
                
                showNotification(message, 'success');
                
                // If user was just locked and might be online, force immediate logout check
                if (user.locked) {
                    forceLogoutUser(user.id);
                }
            }
        }

        function forceLogoutUser(userId) {
            // This function will be called to immediately check if the user is online and log them out
            // In a real application, this would use WebSocket or server-side push
            // For this demo, we'll store the lock action and check on next interval
            console.log(`Force logout check triggered for user ID: ${userId}`);
            
            // Add to immediate logout queue
            if (!window.pendingLogouts) {
                window.pendingLogouts = [];
            }
            window.pendingLogouts.push(userId);
        }

        function renewUserPlan(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                // Create renewal modal HTML
                const modalHtml = `
                    <div id="renewalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-6 w-96">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-redo mr-2"></i>Renew Plan for ${user.name}
                            </h3>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Plan</label>
                                <select id="renewalPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="monthly" ${user.subscription.plan === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="weekly" ${user.subscription.plan === 'weekly' ? 'selected' : ''}>Weekly</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Expiry: ${formatExpiryDate(user.subscription.expiryDate)}</label>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeRenewalModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    Cancel
                                </button>
                                <button onclick="confirmRenewal(${userId})" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
                                    <i class="fas fa-check mr-2"></i>Renew Plan
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
        }

        function closeRenewalModal() {
            const modal = document.getElementById('renewalModal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmRenewal(userId) {
            const user = users.find(u => u.id === userId);
            const newPlan = document.getElementById('renewalPlan').value;
            
            if (user) {
                // Update user subscription
                user.subscription.status = 'active';
                user.subscription.plan = newPlan;
                user.subscription.startDate = new Date().toISOString().split('T')[0];
                user.subscription.expiryDate = getExpiryDate(newPlan);
                
                // Save changes
                saveUsers();
                
                // Update table
                loadUsersTable();
                updateUserStatistics();
                
                // Close modal
                closeRenewalModal();
                
                // Show success notification
                showNotification(`Plan renewed successfully for ${user.name}! New expiry: ${formatExpiryDate(user.subscription.expiryDate)}`, 'success');
            }
        }

        function formatExpiryDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'expired': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function createUser() {
            const name = document.getElementById('newUserName').value;
            const whatsapp = document.getElementById('newUserWhatsApp').value;
            const zoomLink = document.getElementById('newUserZoomLink').value;
            const plan = document.getElementById('newUserPlan').value;

            console.log('Creating user:', { name, whatsapp, zoomLink, plan });

            if (!name || !whatsapp || !zoomLink) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            // Get already generated User ID and Password
            const userId = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;

            const newUser = {
                id: Date.now(),
                userId,
                name,
                whatsapp,
                email: userId + '@linehunter.com',
                password,
                role: 'user',
                zoomLink,
                locked: false, // Default unlocked
                subscription: {
                    status: 'active', // Default status is active
                    plan,
                    startDate: new Date().toISOString().split('T')[0],
                    expiryDate: getExpiryDate(plan)
                }
            };

            console.log('New user object:', newUser);

            users.push(newUser);
            saveUsers();
            loadUsersTable();
            updateUserStatistics();
            
            // Clear form and close modal
            clearUserForm();
            closeCreateUserModal();
            
            // Show user credentials to admin
            showNotification(`User created successfully! User ID: ${userId}, Password: ${password}`, 'success');
            console.log('All users after creation:', users);
        }

        function generateUserId(userName) {
            // If no user name provided, generate random
            if (!userName || userName.trim() === '') {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let userId = '';
                for (let i = 0; i < 6; i++) {
                    userId += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return userId;
            }
            
            // Generate User ID based on user name
            const cleanName = userName.trim().toUpperCase().replace(/[^A-Z]/g, '');
            
            // Take first 3 letters of name (or less if name is shorter)
            let userId = cleanName.substring(0, 3);
            
            // Add 3 random numbers to make it 6 characters
            for (let i = 0; i < 3; i++) {
                userId += Math.floor(Math.random() * 10);
            }
            
            // Ensure it's exactly 6 characters
            if (userId.length < 6) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                while (userId.length < 6) {
                    userId += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            } else if (userId.length > 6) {
                userId = userId.substring(0, 6);
            }
            
            return userId;
        }

        function generatePassword(userName) {
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const special = '!@#$%^&*';
            
            let password = '';
            
            if (userName && userName.trim() !== '') {
                // Generate password based on user name
                const cleanName = userName.trim().toLowerCase().replace(/[^a-z]/g, '');
                
                // 1 uppercase letter (first letter of name)
                if (cleanName.length > 0) {
                    password += cleanName[0].toUpperCase();
                } else {
                    password += uppercase.charAt(Math.floor(Math.random() * uppercase.length));
                }
                
                // 1 special character
                password += special.charAt(Math.floor(Math.random() * special.length));
                
                // 3 numbers (based on name length)
                const nameLength = cleanName.length || 3;
                for (let i = 0; i < 3; i++) {
                    password += (nameLength + i) % 10;
                }
                
                // 3 lowercase letters (next 3 letters of name)
                for (let i = 0; i < 3; i++) {
                    if (i < cleanName.length) {
                        password += cleanName[i];
                    } else {
                        password += lowercase.charAt(Math.floor(Math.random() * lowercase.length));
                    }
                }
            } else {
                // Generate random password if no name provided
                // 1 uppercase letter
                password += uppercase.charAt(Math.floor(Math.random() * uppercase.length));
                
                // 1 special character
                password += special.charAt(Math.floor(Math.random() * special.length));
                
                // 3 numbers
                for (let i = 0; i < 3; i++) {
                    password += numbers.charAt(Math.floor(Math.random() * numbers.length));
                }
                
                // 3 lowercase letters
                for (let i = 0; i < 3; i++) {
                    password += lowercase.charAt(Math.floor(Math.random() * lowercase.length));
                }
            }
            
            // Shuffle the password characters
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'expired': return 'bg-red-100 text-red-800';
                case 'inactive': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getExpiryDate(plan) {
            const now = new Date();
            if (plan === 'weekly') {
                now.setDate(now.getDate() + 7);
            } else if (plan === 'monthly') {
                now.setDate(now.getDate() + 30); // 30 days instead of 1 month
            }
            return now.toISOString().split('T')[0];
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                saveUsers();
                loadUsersTable();
                updateUserStatistics();
                showNotification('User deleted successfully', 'success');
            }
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                // Fill the form with current user data
                document.getElementById('newUserName').value = user.name;
                document.getElementById('newUserWhatsApp').value = user.whatsapp || '';
                document.getElementById('newUserEmail').value = user.userId;
                document.getElementById('newUserPassword').value = user.password;
                document.getElementById('newUserZoomLink').value = user.zoomLink;
                document.getElementById('newUserPlan').value = user.subscription.plan;
                
                // Store the editing user ID
                window.editingUserId = userId;
                
                // Change button text to indicate editing mode
                const createBtn = document.querySelector('button[onclick="createUser()"]');
                createBtn.textContent = 'Update User';
                createBtn.setAttribute('onclick', 'updateUser()');
                
                showNotification('Edit the user details and click Update User', 'info');
            }
        }

        function updateUser() {
            const name = document.getElementById('newUserName').value;
            const whatsapp = document.getElementById('newUserWhatsApp').value;
            const userId = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const zoomLink = document.getElementById('newUserZoomLink').value;
            const plan = document.getElementById('newUserPlan').value;
            const status = document.getElementById('newUserStatus').value;

            if (!name || !whatsapp || !userId || !password || !zoomLink) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            // Find and update the user
            const userIndex = users.findIndex(u => u.id === window.editingUserId);
            if (userIndex !== -1) {
                users[userIndex] = {
                    ...users[userIndex],
                    userId,
                    name,
                    whatsapp,
                    email: userId + '@linehunter.com',
                    password,
                    zoomLink,
                    subscription: {
                        ...users[userIndex].subscription,
                        status,
                        plan,
                        expiryDate: status === 'active' ? getExpiryDate(plan) : users[userIndex].subscription.expiryDate
                    }
                };
                
                saveUsers();
                loadUsersTable();
                
                // Clear form and reset button
                clearUserForm();
                
                showNotification('User updated successfully!', 'success');
            }
        }

        function clearUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserWhatsApp').value = '';
            document.getElementById('newUserZoomLink').value = '';
            document.getElementById('newUserPlan').value = 'monthly';
            
            // Reset button to create mode
            const createBtn = document.querySelector('button[onclick="updateUser()"]');
            if (createBtn) {
                createBtn.textContent = 'Create User';
                createBtn.setAttribute('onclick', 'createUser()');
            }
            
            window.editingUserId = null;
        }

        function togglePassword(userId) {
            const passwordSpan = document.getElementById(`password-${userId}`);
            const eyeIcon = document.getElementById(`eye-icon-${userId}`);
            const user = users.find(u => u.id === userId);
            
            if (passwordSpan.textContent === '*****') {
                // Show password
                passwordSpan.textContent = user.password;
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                // Hide password
                passwordSpan.textContent = '*****';
                eyeIcon.className = 'fas fa-eye';
            }
        }

        function regeneratePassword(userId) {
            if (confirm('Are you sure you want to generate a new password for this user?')) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    // Generate new password based on user name
                    const newPassword = generatePassword(user.name);
                    user.password = newPassword;
                    
                    // Save changes
                    saveUsers();
                    
                    // Update display
                    const passwordSpan = document.getElementById(`password-${userId}`);
                    const eyeIcon = document.getElementById(`eye-icon-${userId}`);
                    
                    // Show the new password
                    passwordSpan.textContent = newPassword;
                    eyeIcon.className = 'fas fa-eye-slash';
                    
                    showNotification(`Password regenerated successfully for ${user.name}: ${newPassword}`, 'success');
                }
            }
        }

        function updateUserStatistics() {
            const allUsers = users.filter(u => u.role !== 'admin');
            const activeUsers = allUsers.filter(u => u.subscription.status === 'active');
            const expiredUsers = allUsers.filter(u => u.subscription.status === 'expired');
            
            document.getElementById('totalUsersCount').textContent = allUsers.length;
            document.getElementById('activeUsersCount').textContent = activeUsers.length;
            document.getElementById('expiredUsersCount').textContent = expiredUsers.length;
        }

        function openCreateUserModal() {
            // Show the create user form
            document.getElementById('createUserForm').classList.remove('hidden');
            // Clear any existing form data
            clearUserForm();
            // Generate and show User ID and Password immediately
            generateAndShowCredentials();
            // Focus on the first input field
            document.getElementById('newUserName').focus();
        }

        function updateUserId() {
            // Generate new User ID based on current user name
            const userName = document.getElementById('newUserName').value;
            const userId = generateUserId(userName);
            document.getElementById('newUserEmail').value = userId;
            
            // Also generate new password based on user name
            const password = generatePassword(userName);
            document.getElementById('newUserPassword').value = password;
        }

        function generateAndShowCredentials() {
            // Get user name to generate related User ID
            const userName = document.getElementById('newUserName').value;
            
            // Generate 6-character User ID based on user name
            const userId = generateUserId(userName);
            
            // Generate 8-character password with required format
            const password = generatePassword();
            
            // Show generated credentials to admin
            document.getElementById('newUserEmail').value = userId;
            document.getElementById('newUserPassword').value = password;
        }

        function closeCreateUserModal() {
            // Hide the create user form
            document.getElementById('createUserForm').classList.add('hidden');
            // Clear form data
            clearUserForm();
        }

        function scrollToCreateUser() {
            // Scroll to the create user form
            document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
            // Focus on the first input field
            document.getElementById('newUserName').focus();
        }

        function startCountdown(expiryDate) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const expiry = new Date(expiryDate).getTime();
                const distance = expiry - now;

                if (distance < 0) {
                    document.getElementById('countdown').innerHTML = "EXPIRED";
                    clearInterval(countdownInterval);
                    return;
                }

                // Calculate exact days remaining
                const totalDays = distance / (1000 * 60 * 60 * 24);
                const days = Math.floor(totalDays); // Show full completed days
                const remainingHours = Math.floor((totalDays - days) * 24); // Calculate remaining hours from fractional part
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('countdown').innerHTML = 
                    `${days} Days ${remainingHours} Hours ${minutes} Minutes ${seconds} Seconds`;
            }, 1000);
        }

        function joinZoomMeeting() {
            if (currentUser && currentUser.zoomLink) {
                window.open(currentUser.zoomLink, '_blank');
            } else {
                showNotification('No Zoom link available', 'error');
            }
        }

        function logout() {
            currentUser = null;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            if (expiryCheckInterval) {
                clearInterval(expiryCheckInterval);
            }
            
            if (sessionTimeoutInterval) {
                clearInterval(sessionTimeoutInterval);
            }
            
            sessionStartTime = null;
            
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            // Clear login form
            document.getElementById('loginUserId').value = '';
            document.getElementById('loginPassword').value = '';
            
            showNotification('Logged out successfully', 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 fade-in ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleAuthMode() {
            showNotification('Please contact admin to create an account', 'info');
        }
    </script>
</body>
</html>
